import IO;
import List;

class IntList:

delegate * : l: List<int64>;

static create() -> IntList {
    return new IntList(l=List<int64>.create());
}


class Generic<T>:
delegate * : i: int32;
t: T;

static create(t: T, i: int32) -> Generic<T> {
    return new Generic<T>(i=i ,t=t);
}

doSthUseful<R>(fun: (T, int32 -> R)) -> R {
    return fun(t,i);
}

getT() -> T {
    return t;
}

class MoreGenerix<U>:
delegate doSthUseful, getT : baseGeneric: Generic<U>;

static create(baseGeneric: Generic<U>) -> MoreGenerix<U> {
    return new MoreGenerix<U>(baseGeneric=baseGeneric);
}

export class Outside:

static forEach <T, R> (l: List<T>, f: (T->R)) { //das geht nicht aber sollte mit delegate cast gehen?
    i:int32 = 0;
    while i < l.size() {
        f(l.elements()[i]);
        ++i;
    }
}


static createGenericWithDelegateFromOutside() -> Generic<int32> {
    return Generic<int32>.create(5,6);
}

static overload (i: Generic<int32>) {
    IO.print("one");
}

static overload <T> (i: Generic<T>) {
    IO.print("two");
}

static overload (i: int32) {
    IO.print("three");
}

static overload2 <T> (i: Generic<T>) {
    IO.print("two");
}

static overload2 (i: int32) {
    IO.print("three");
}


export static main () {
    //instantiated generic in non generic
    intList := IntList.create();
    intList.add(10);
    intList.add(9);
    intList.add(8);
    forEach(intList, IO.printInt*);

    IO.print("|");

    //forwarding non generic in generic
    gen := createGenericWithDelegateFromOutside();
    //IO.printInt(gen.doSthUseful(\i j -> i+j)); //TODO i32<returnvalue<i64, so maybe this is correct to fail here, should analyse
    IO.printInt(gen.doSthUseful(\int32 i int32 j -> i+j)); //so giving types is enough, nice
    IO.printInt(gen);

    IO.print("|");

    //in a generic class, forward from a generic class, but in the instantiation we use a type parameter of the current class
    moregen := MoreGenerix<List<int64>>.create(Generic<List<int64>>.create(intList,49));
    moregen.getT().add(51);
    forEach(intList, IO.printInt*);
    IO.printInt(moregen.getT().get(3));

    IO.print("|");

    IO.printInt(moregen.doSthUseful(\i j -> i.get(0) + j));

    IO.print("|");

    overload(gen);
    overload2(gen);
}